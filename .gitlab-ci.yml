stages:
  - test
  - build
  - bench

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'web'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

services:
  - name: docker:24.0.5-dind
    alias: docker

variables:
  DOCKER_BUILDKIT: 1
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_TLS_CERTDIR: ""

build:docker:
  image: docker:24.0.5
  script:
    - |
      docker buildx create --use
      docker buildx build \
      --cache-from=type=local,src=/cache/docker \
      --cache-to=type=local,dest=/cache/docker,mode=max \
      --tag jlewallen/burrow \
      --target builder .
    - ls -alh /cache /cache/docker*

tests:
  stage: test
  when: manual
  image: docker:24.0.5
  needs: [build:docker]
  script:
    - |
      docker buildx create --use
      docker buildx build \
      --cache-from=type=local,src=/cache/docker \
      --cache-to=type=local,dest=/cache/docker,mode=max \
      --tag jlewallen/burrow-tests \
      --target tests .
    - docker run --rm jlewallen/burrow-tests "cargo test --workspace"

bench:all:
  stage: bench
  when: manual
  image: docker:24.0.5
  needs: [tests]
  script:
    - |
      docker buildx create --use
      docker buildx build \
      --cache-from=type=local,src=/cache/docker \
      --cache-to=type=local,dest=/cache/docker,mode=max \
      --tag jlewallen/burrow-tests \
      --target=tests .
    - docker run --rm jlewallen/burrow-tests "cargo bench --workspace --verbose"
    - docker run --rm jlewallen/burrow-tests "cd libs/tests && cargo bench --bench simple -- --profile-time=5"
